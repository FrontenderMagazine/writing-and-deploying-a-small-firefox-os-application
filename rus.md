# Создание и сборка простого приложения для Firefox OS

Всю прошлую неделю я использовал [Geeksphone Keon][1] в качестве своего
единственного телефона. Никакого жульничества с запасным телефоном на Android
и таскания с собой планшета (хотя дома я стал использовать его несколько больше)
В целом впечатления положительные. Учитывая то, как я привык к приложениям на
Android и сервисам Google, я сменил платформу удивительно легко. Так что могу
порекомендовать купить Geeksphones и начинать [создавать свои собственные сборки ОС][2],
так как та, что идет из коробки совсем бедная.

Среди множества нужных приложений (Spotify в моем списке — первый), таймер
обратного отсчета. Несмотря на впечатление, которое производят интерфейсы
приложений на Android написать приличный таймер не особенно сложно, так что
я решил, что его написание — отличный первый шаг в создании мобильных
приложений. По большей части это будет обычная веб-страничка, но мне хотелось
что бы приложение казалось нативным, так что я отправился на
[сайт с готовыми элементами][3] на котором можно увидеть элементы FirefoxOS
находящиеся в открытом доступе. Я собирался искать там вкладки и шапки и т.п.,
но на деле мне понадобились только стили для кнопки. Из информации на сайте
не особенно очевидно, что эти элементы на самом деле находятся на [GitHub][4] и
вам придется в них покопаться.

Написать приложение было просто, кроме, вероятно, вертикального выравнивания
(для которого я использовал вложенные дивы и трюк с `display: table-cell; vertical-alignment: middle;`),
но все немного усложнилось, как только я решил использовать новые API.
А конкретнее, я хотел что бы таймер работал даже когда приложение закрыто и
подавал сигнал об окончании отсчета только тогда, когда ты его не видишь.
Для этого мне понадобилось использовать [Alarm API][5], [Notifications API][6] и
[Page Visibility API][7].

Назначение Page Visibility API достаточно очевидно, и у меня не возникло никаких
проблем с его использованием. Я использовал его что бы узнавать работает ли
приложение в фоновом режиме (Переход в него происходит, когда вы закрываете
приложение. По идее). Когда приложение переходило в фоновый режим я устанавливал
с помощью Alarm API сигнал на время, которое осталось в этот момент на таймере,
что бы своевременно вызвать приложение. Использовать его было весьма проблематично
из за того, что оно плохо документировано (впрочем, сам код оказался очень простым).
И наконец, я использовал Notifications API что бы уведомить пользователя, если
приложение в фоновом режиме в момент, когда отсчет таймера заканчивается.
Создавать уведомление оказалось достаточно просто, но я пока так и не выяснил
как по клику на уведомление выводить приложение из фонового режима — понятия
не имею где я ошибся, любая помощь приветствуется!

Последняя проблема — сборка приложения на реальном устройстве, вместо [симулятора][8].
Естественно симулятор позволяет задеплоить приложение на телефон, но мне это
не подходило, так как это бы означало необходимость запускать его в виртуальной
машине с Linux (у меня были причины этого не делать), а для Windows пока нет
необходимых для Geeksphone драйверов. Мне совершенно не хотелось отправлять
приложение в Firefox-маркет в таком виде, так как оно было практически не
оттестировано. У меня есть VPS, я решил выложить приложение туда, добавить
соответствующий мета-тег и попробовать запустить его на реальном устройстве
оттуда, но к сожалению все оказалось не так просто.

Сначала надо заставить его работать как обычную веб-страницу, для этого нужно
добавить [мета-тег вьюпорта][9]. Заставить приложение установиться на
устройство с веб-страницы не сложно, а вот чтобы выяснить, как именно это делается
пришлось потрудится. Мне кажется, что процесс необоснованно сложный и слишком
плохо документирован, но в общем случае нужный вам код будет выглядеть следующим
образом:

    if (navigator.mozApps) {
      var request = navigator.mozApps.getSelf();
      request.onsuccess = function() {
        if (!this.result) {
          request = navigator.mozApps.install(location.protocol + "//" + location.host + location.pathname + "manifest.webapp");
          request.onerror = function() {
            console.log("Install failed: " + this.error.name);
          };
        }
      };
    }

Все пути к [манифесту][10] приложения и [appcache][11] должны быть абсолютными
(можно не указывать хост, но вы не сможете установить путь относительно текущего
директория). Последнее делает процесс сборки приложения весьма неудобным,
если вы конечно не захотите хранить все в корневом директорие или создавать
по виртуальному серверу для каждого приложения. Кроме того нужно убедиться,
что на сервере настроен [mime-тип для веб-приложений][12]. Mozilla предоставляет
отличный [онлайн инструмент для проверки приложения][13], который позволит
провести его отладку.

![Скриншот][Наше приложение]

[Готово!][14] (Ctrl+Shift+M что бы включить режим адаптивного дизайна в Firefox)

При посещении странички с подходящего устройства (любого на Firefox OS) вам
предложат установить приложение. Не плохо для одной ночи! Можете поржать над
[исходниками][14] и рассказать о том насколько они ужасны в комментариях.

[1]: http://www.geeksphone.com/#feat
[2]: https://developer.mozilla.org/en-US/docs/Mozilla/Firefox_OS/Building
[3]: http://buildingfirefoxos.com/
[4]: https://github.com/mozilla-b2g/gaia/tree/master/shared
[5]: https://developer.mozilla.org/en-US/docs/WebAPI/Alarm
[6]: https://developer.mozilla.org/en-US/docs/DOM/Displaying_notifications
[7]: https://developer.mozilla.org/en-US/docs/DOM/Using_the_Page_Visibility_API
[8]: https://addons.mozilla.org/en-US/firefox/addon/firefox-os-simulator/
[9]: https://developer.mozilla.org/en-US/docs/Mobile/Viewport_meta_tag
[10]: https://developer.mozilla.org/en-US/docs/Apps/Manifest
[11]: https://developer.mozilla.org/en-US/docs/HTML/Using_the_application_cache
[12]: https://developer.mozilla.org/en-US/docs/Apps/Manifest#Serving_manifests
[13]: https://marketplace.firefox.com/developers/validator
[14]: http://chrislord.net/demos/timer/

[Наше приложение]: img/timer.png "Наше приложение"
